<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIRECCI√ìN EDITORIAL - ILFASS V5</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --border: #27272a;
            --text-main: #e4e4e7;
            --accent: #38bdf8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            font-size: 14px;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        /* TOP BAR: EDITORIAL CONTROL */
        .editorial-bar {
            background: #000;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .rec-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'JetBrains Mono';
            font-weight: bold;
            color: #555;
        }

        .rec-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
        }

        .rec-live .rec-dot {
            background: var(--danger);
            animation: pulseRec 1s infinite;
        }

        .rec-live span {
            color: var(--danger);
        }

        @keyframes pulseRec {
            50% {
                opacity: 0.5;
            }
        }

        /* MAIN GRID */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            height: 100%;
            overflow: hidden;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            height: 100%;
        }

        /* PANELS */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }

        h2 {
            font-family: 'JetBrains Mono';
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #71717a;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin: 0 0 15px 0;
        }

        /* CONTROLS */
        button {
            font-family: 'JetBrains Mono';
            background: #27272a;
            color: white;
            border: 1px solid #3f3f46;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        button:active:not(:disabled) {
            transform: translateY(1px);
        }

        input,
        select {
            background: #000;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            width: 100%;
            font-family: 'JetBrains Mono';
            margin-bottom: 10px;
        }

        /* STATUS */
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .stat-val {
            font-family: 'JetBrains Mono';
            color: var(--accent);
        }

        /* DREAM MODE SWITCH */
        .dream-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(168, 85, 247, 0.1);
            padding: 10px;
            border: 1px solid #a855f7;
            border-radius: 4px;
            margin-top: 10px;
        }

        .dream-label {
            color: #a855f7;
            font-weight: bold;
            font-family: 'JetBrains Mono';
        }

        .active-red {
            background-color: rgba(220, 38, 38, 0.2) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            animation: pulseRec 2s infinite;
        }
    </style>
</head>

<body>

    <!-- TOP BAR: SESSION CONTROL -->
    <div class="editorial-bar">
        <div style="display: flex; gap: 20px; align-items: center;">
            <div id="rec-status" class="rec-indicator">
                <div class="rec-dot"></div>
                <span>SESSION IDLE</span>
            </div>
            <div id="session-timer" style="font-family: 'JetBrains Mono'; color: #888;">00:00:00</div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 5px; color: #888; font-size: 0.7rem;">
                <input type="checkbox" id="sim-mode" style="width: auto; margin: 0;">
                <label for="sim-mode">TEST MODE</label>
            </div>
            <input type="text" id="day-id-input" placeholder="ID del D√≠a (ej: D√≠a 1)" style="width: 150px; margin: 0;">
            <button onclick="startDay()" id="btn-start-day"
                style="width: auto; background: var(--success); color: black; font-weight: bold;">
                ‚ñ∂ START DAY
            </button>
            <button onclick="endDay()" id="btn-end-day"
                style="width: auto; background: var(--danger); color: white; display: none;">
                ‚èπ END SESSION & ARCHIVE
            </button>
        </div>
    </div>

    <div class="main-grid">

        <!-- COL 1: NAVIGATION & PLAYLIST -->
        <div class="col">
            <div class="panel">
                <h2>Navigation (Director)</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px;">
                    <button onclick="changeScene('intro')">üè† Cover</button>
                    <button onclick="changeScene('mapa')">üåç Map</button>
                    <button onclick="changeScene('reflexion')">üìñ Book</button>
                    <button onclick="changeScene('pais')">üè≥Ô∏è Detail</button>
                </div>

                <h2 style="margin-top: 20px;">Flight Control</h2>
                <select id="country-select" onchange="loadCountryMedia()">
                    <option value="" disabled selected>Select Destination...</option>
                </select>
                <div style="display: flex; gap: 5px;">
                    <button onclick="travelNow()">‚úàÔ∏è FLY NOW</button>
                    <button onclick="addToQueue()" style="width: 50px;">+</button>
                </div>
            </div>

            <div class="panel" style="flex: 1;">
                <h2>Travel Playlist</h2>
                <div id="playlist-container" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: #aaa;">
                    (Empty Queue)
                </div>
            </div>
        </div>

        <!-- COL 2: LIVE CONTENT (M.C.D) -->
        <div class="col">
            <div class="panel">
                <h2>Live Context</h2>
                <div class="stat-row">
                    <span>ACTIVE VISIT:</span>
                    <span id="live-visit" class="stat-val">NONE</span>
                </div>
                <div class="stat-row">
                    <span>DURATION:</span>
                    <span id="visit-timer" class="stat-val">--:--</span>
                </div>
            </div>

            <div class="panel" style="flex: 1;">
                <h2>Media Repository (Curated)</h2>
                <div id="media-grid"
                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; overflow-y: auto; max-height: 400px;">
                    <div style="grid-column: span 2; text-align: center; padding: 40px; color: #444;">Select a country
                        to load media.</div>
                </div>
            </div>
        </div>

        <!-- COL 3: AI & NEURAL CORE -->
        <div class="col">
            <div class="panel">
                <h2>Neural Core Control</h2>

                <div class="dream-switch">
                    <span class="dream-label">DREAM MODE (Auto)</span>
                    <button id="btn-dream-toggle" onclick="toggleDreamMode()" style="width: 80px;">OFF</button>
                </div>
                <div style="font-size: 0.7rem; color: #a855f7; margin-top: 5px; text-align: center;">
                    If ON: AI controls navigation & media autonomously.
                </div>

                <button onclick="triggerForceDream()" style="margin-top: 15px; border-color: #a855f7; color: #a855f7;">
                    Force Single Dream Gen
                </button>
            </div>

            <div class="panel">
                <h2>Direct Interventions</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="triggerEvent('fact')">üí° FACT</button>
                    <button onclick="triggerEvent('glitch')">‚ö° GLITCH</button>
                    <button onclick="triggerEvent('news')"
                        style="grid-column: span 2; border-color: var(--danger); color: var(--danger);">üö® BREAKING
                        NEWS</button>
                </div>
            </div>

            <div class="panel" style="flex: 1; min-height: 200px;">
                <h2>Console Log</h2>
                <div id="console"
                    style="font-family: 'JetBrains Mono'; font-size: 0.7rem; color: #666; overflow-y: auto;"></div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG & STATE ---
        const ALL_COUNTRIES = [
            { code: '032', name: 'Argentina' }, { code: '076', name: 'Brazil' },
            { code: '840', name: 'USA' }, { code: '156', name: 'China' },
            { code: '392', name: 'Japan' }, { code: '250', name: 'France' },
            { code: '276', name: 'Germany' }, { code: '380', name: 'Italy' },
            { code: '724', name: 'Spain' }, { code: '826', name: 'UK' },
            { code: '643', name: 'Russia' }, { code: '356', name: 'India' },
            { code: '036', name: 'Australia' }, { code: '124', name: 'Canada' },
            { code: '484', name: 'Mexico' }, { code: '710', name: 'South Africa' }
        ];

        const MOCK_MEDIA = {
            '032': [
                { src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Glaciar_Perito_Moreno_-_Santa_Cruz_-_Argentina.jpg/800px-Glaciar_Perito_Moreno_-_Santa_Cruz_-_Argentina.jpg', title: 'Perito Moreno' },
                { src: 'https://media.istockphoto.com/id/1146311634/es/foto/obelisco-buenos-aires-argentina.jpg?s=612x612&w=0&k=20&c=XMrz330d-i-4LqW8S2R2c5g9-k0Wb0d4E8q7G9n8G5k=', title: 'Obelisco' }
            ],
            '392': [
                { src: 'https://dummyimage.com/600x400/000/fff&text=Tokyo+Skyline', title: 'Tokyo Night' },
                { src: 'https://dummyimage.com/600x400/000/fff&text=Kyoto+Garden', title: 'Kyoto Garden' }
            ]
        };

        let sessionActive = false;
        let dreamMode = false;

        // --- INIT ---
        window.onload = () => {
            const sel = document.getElementById('country-select');
            ALL_COUNTRIES.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code; opt.text = c.name;
                sel.add(opt);
            });

            setInterval(poll, 1000);
            poll(); // Initial
        };

        // --- API & LOG ---
        function log(msg) {
            const c = document.getElementById('console');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            c.prepend(d);
        }

        async function api(path, method = 'GET', body = {}) {
            if (method === 'GET') body = null;
            try {
                const opts = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) opts.body = JSON.stringify(body);
                const res = await fetch(`/control-api${path}`, opts);
                return await res.json();
            } catch (e) { console.error(e); return null; }
        }

        // --- EDITORIAL ACTIONS ---
        async function startDay() {
            const id = document.getElementById('day-id-input').value;
            const isTest = document.getElementById('sim-mode').checked;
            if (!id) return alert("Enter Day ID");
            log(`Starting Editorial Day: ${id} (Test: ${isTest})`);
            await api('/event/day/start', 'POST', { id, isTest });
        }

        async function endDay() {
            if (!confirm("End Season and Archive?")) return;
            log("Ending Session...");
            await api('/event/day/end', 'POST');
        }

        async function changeScene(name) {
            log(`Scene -> ${name}`);
            await api(`/event/scene/${name}`);
        }

        async function travelNow() {
            const code = document.getElementById('country-select').value;
            if (!code) return;
            log(`Flying to: ${code}`);
            await api(`/event/travel/${code}`);
        }

        async function addToQueue() {
            const code = document.getElementById('country-select').value;
            if (!code) return;
            log(`+ Queue: ${code}`);
            await api('/event/queue/add', 'POST', { code });
        }

        async function toggleDreamMode() {
            // This is the new AUTO toggle
            log("Toggling Dream/Auto Mode...");
            await api('/event/auto_toggle', 'POST');
        }

        let globalMediaCache = [];
        let currentTypeFilter = 'ALL';

        async function loadCountryMedia() {
            // Cargar repositorio real del servidor
            const gridContainer = document.getElementById('media-grid').parentNode;
            if (!document.getElementById('media-filters')) {
                const filterDiv = document.createElement('div');
                filterDiv.id = 'media-filters';
                filterDiv.style.marginBottom = '10px';
                filterDiv.style.display = 'flex';
                filterDiv.style.gap = '5px';
                filterDiv.innerHTML = `
                    <button onclick="setMediaFilter('ALL')" style="flex:1; padding:2px; font-size:0.7rem;">ALL</button>
                    <button onclick="setMediaFilter('image')" style="flex:1; padding:2px; font-size:0.7rem;">IMG</button>
                    <button onclick="setMediaFilter('video')" style="flex:1; padding:2px; font-size:0.7rem;">VID</button>
                    <button onclick="setMediaFilter('AI')" style="flex:1; padding:2px; font-size:0.7rem; color:cyan; border-color:cyan;">AI</button>
                `;
                gridContainer.insertBefore(filterDiv, document.getElementById('media-grid'));
            }

            const grid = document.getElementById('media-grid');
            grid.innerHTML = '<div style="grid-column:span 2; text-align:center; padding:20px; color:#555;">Loading Server Media...</div>';

            try {
                const mediaFiles = await api('/api/media-list');
                globalMediaCache = mediaFiles || [];
                renderMediaGrid();
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<div style="grid-column:span 2; text-align:center; padding:20px; color:red;">Error loading media.</div>';
            }
        }

        function setMediaFilter(type) {
            currentTypeFilter = type;
            renderMediaGrid();
        }

        function renderMediaGrid() {
            const grid = document.getElementById('media-grid');
            grid.innerHTML = "";
            const selectEl = document.getElementById('country-select');
            const rawText = selectEl.options[selectEl.selectedIndex].text;
            const countryName = rawText.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, '').trim();

            const filtered = globalMediaCache.filter(m => {
                const folder = (m.folder || "").toLowerCase();
                const target = countryName.toLowerCase();
                const folderMatch = folder.includes(target) || target.includes(folder) || folder === 'global';

                let typeMatch = true;
                if (currentTypeFilter === 'AI') typeMatch = m.name.includes('AI_');
                else if (currentTypeFilter !== 'ALL') typeMatch = (m.type === currentTypeFilter);

                return folderMatch && typeMatch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:20px; color:#555;">No media for ${countryName}.<br><small>Upload to /media/${countryName}/</small></div>`;
                return;
            }

            filtered.forEach(m => {
                const el = document.createElement('div');
                el.style.border = "1px solid #333";
                el.style.padding = "5px";

                let preview = '';
                if (m.type === 'video') preview = `<div style="height:80px; background:#000; color:#fff; display:flex; align-items:center; justify-content:center;">üé•</div>`;
                else if (m.type === 'audio') preview = `<div style="height:80px; background:#222; color:#fff; display:flex; align-items:center; justify-content:center;">üéµ</div>`;
                else preview = `<div style="height:80px; background:url('${m.url}') center/cover;"></div>`;

                el.innerHTML = `
                    ${preview}
                    <div style="font-size:0.6rem; margin:5px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${m.name}</div>
                    <button onclick="launchMedia('${m.url}', '${m.type}')" style="font-size:0.6rem; background:#333; width:100%;">LAUNCH</button>
                `;
                grid.appendChild(el);
            });
        }

        document.getElementById('country-select').addEventListener('change', () => renderMediaGrid());

        async function launchMedia(url, type) {
            log(`Launching Media: ${url}`);
            await api('/event/media', 'POST', { url, type });
        }

        async function triggerEvent(type) {
            log(`Triggering Event: ${type}`);
            await api(`/event/${type}`);
        }

        async function triggerForceDream() {
            log("Forcing Dream Generation...");
            await api('/api/dream', 'POST');
        }

        // --- POLLING ---
        async function poll() {
            const data = await api('/status');
            if (!data) return;

            // 1. Session Status
            const ed = data.editorial || {};
            sessionActive = (ed.status === 'LIVE');
            const recStatus = document.getElementById('rec-status');
            const btnStart = document.getElementById('btn-start-day');
            const btnEnd = document.getElementById('btn-end-day');
            const navCols = document.querySelectorAll('.col');

            if (sessionActive) {
                recStatus.className = "rec-indicator rec-live";
                recStatus.querySelector('span').innerText = `LIVE: ${ed.dayId}`;
                btnStart.style.display = 'none';
                btnEnd.style.display = 'block';
                document.getElementById('day-id-input').style.display = 'none';

                // Timer
                const diff = Math.floor((Date.now() - ed.startTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('session-timer').innerText = `${h}:${m}:${s}`;

                // Live Visit
                if (ed.currentVisit) {
                    document.getElementById('live-visit').innerText = ed.currentVisit.country;
                } else {
                    document.getElementById('live-visit').innerText = "TRANSIT / INTRO";
                }

            } else {
                recStatus.className = "rec-indicator";
                recStatus.querySelector('span').innerText = "SESSION IDLE";
                btnStart.style.display = 'block';
                btnEnd.style.display = 'none';
                document.getElementById('day-id-input').style.display = 'block';
                document.getElementById('session-timer').innerText = "00:00:00";
            }

            // 2. Playlist
            const pl = document.getElementById('playlist-container');
            if (data.queue && data.queue.length) {
                pl.innerHTML = data.queue.map((c, i) => `<div>${i + 1}. ${c}</div>`).join('');
            } else {
                pl.innerText = "(Empty Queue)";
            }

            // 3. Dream Mode
            const btnDream = document.getElementById('btn-dream-toggle');
            if (data.autoMode) {
                btnDream.innerText = "ON";
                btnDream.className = "active-red";
            } else {
                btnDream.innerText = "OFF";
                btnDream.className = "";
            }
        }
    </script>
</body>

</html>