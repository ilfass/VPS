<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIRECCI√ìN - ILFASS CONTROL V4</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #71717a;
            --accent: #38bdf8;
            /* Cyan */
            --danger: #ef4444;
            /* Red */
            --success: #10b981;
            /* Green */
            --warning: #f59e0b;
            /* Amber */
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            font-size: 14px;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
        }

        /* LAYOUT COLUMNS */
        .col {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
        }

        /* PANELS */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin: 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        /* INDICATORS */
        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            background: #333;
        }

        .indicator.on {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .indicator.busy {
            background: var(--warning);
            animation: blink 1s infinite;
        }

        .indicator.active-danger {
            background: var(--danger);
            box-shadow: 0 0 15px var(--danger);
            animation: pulseRed 2s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        @keyframes pulseRed {
            0% {
                box-shadow: 0 0 5px var(--danger);
            }

            50% {
                box-shadow: 0 0 20px var(--danger);
            }

            100% {
                box-shadow: 0 0 5px var(--danger);
            }
        }

        /* CONTROLS */
        button {
            font-family: 'JetBrains Mono', monospace;
            background: #27272a;
            color: white;
            border: 1px solid #3f3f46;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        button:active:not(:disabled) {
            transform: translateY(1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger-toggle.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        select,
        input[type="text"] {
            background: #000;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            width: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        /* MONITOR */
        .data-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            text-align: center;
            padding: 20px;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--accent);
        }

        /* PLAYLIST */
        #playlist-container {
            min-height: 100px;
            background: #000;
            border: 1px solid var(--border);
            padding: 10px;
            font-family: 'JetBrains Mono';
            font-size: 0.8rem;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #222;
        }

        .playlist-item:hover {
            background: #111;
        }

        .btn-del {
            border: none;
            background: transparent;
            color: var(--danger);
            cursor: pointer;
            padding: 0 5px;
        }

        /* MEDIA REPO */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .media-item {
            background: #000;
            border: 1px solid var(--border);
            padding: 5px;
            border-radius: 4px;
        }

        .media-prev {
            width: 100%;
            height: 80px;
            object-fit: cover;
            background: #333;
        }

        .media-actions button {
            width: 100%;
            margin-top: 5px;
            font-size: 0.65rem;
            padding: 5px;
        }
    </style>
</head>

<body>

    <!-- LEFT: SYSTEM STATUS & PLAYLIST -->
    <div class="col">
        <div class="panel">
            <h2>System Status <div id="sys-led" class="indicator"></div>
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">SCENE</div>
                    <div id="stat-scene" style="color: white; font-weight: bold;">--</div>
                </div>
                <div>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">COUNTRY</div>
                    <div id="stat-country" style="color: var(--accent);">--</div>
                </div>
            </div>

            <button id="btn-auto-mode" onclick="toggleAuto()"
                style="height: 50px; font-weight: bold; font-size: 0.9rem;">
                PILOTO AUTOM√ÅTICO
            </button>
            <div style="text-align: center; font-size: 0.7rem; color: #666;">
                Si ON: El sistema viaja solo (Playlist o Random)
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <h2>Travel Playlist</h2>

            <div id="playlist-container">
                <!-- Items se inyectan aqu√≠ -->
                <div style="text-align: center; color: #444; padding-top: 20px;">Lista vac√≠a</div>
            </div>

            <div style="font-size: 0.7rem; color: #666;">
                El piloto autom√°tico consumir√° esta lista primero.
            </div>
        </div>
    </div>

    <!-- CENTER: NAVIGATION & MEDIA -->
    <div class="col">
        <div class="panel">
            <h2>Flight Navigation</h2>
            <div style="display: flex; gap: 10px;">
                <select id="country-select" onchange="loadCountryMedia()">
                    <option value="" disabled selected>Select Destination...</option>
                    <!-- Options populated by JS -->
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="flyNow()" style="flex: 1; border-color: var(--accent); color: var(--accent);">
                    ‚úàÔ∏è FLY IMMEDIATE
                </button>
                <button onclick="addPlaylist()" style="flex: 1; border-color: var(--warning); color: var(--warning);">
                    + ADD TO PLAYLIST
                </button>
            </div>
        </div>

        <div class="panel" style="flex: 1; min-height: 400px;">
            <h2>Media Repository <span id="media-count" style="font-size: 0.7rem;">(0)</span></h2>

            <!-- Aqu√≠ se muestran los medios del pa√≠s seleccionado -->
            <div id="media-container" class="media-grid">
                <div style="grid-column: span 2; text-align: center; padding: 40px; color: #444;">
                    Selecciona un pa√≠s para ver archivos.
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: AI & ORCHESTRATION -->
    <div class="col">
        <div class="panel">
            <h2>Neural Core</h2>
            <button id="btn-dream" onclick="toggleDream()" class="danger-toggle" style="height: 60px;">
                FORCE DREAM GENERATION
            </button>
            <div style="font-size: 0.7rem; color: #666; margin-top: 5px;">
                Si ON: La IA toma control total (Cambios de escena, Narrativa, Media Flash).
            </div>
        </div>

        <div class="panel">
            <h2>Live Events</h2>
            <button onclick="sendEvent('fact')">üí° Trigger Fact</button>
            <button onclick="sendEvent('glitch')">‚ö° Trigger Glitch</button>
            <button onclick="sendEvent('news')" style="border-color: var(--danger); color: var(--danger);">üö® News
                Injection</button>
        </div>

        <div class="panel"
            style="flex: 1; background: #000; font-family: 'JetBrains Mono'; font-size: 0.7rem; color: #888;">
            <h2>Console</h2>
            <div id="console-log" style="height: 100%; overflow-y: auto; padding-bottom: 20px;"></div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const ALL_COUNTRIES = [
            // Lista ISO reducida para demo, expandir a 195 es trivial con un script
            { code: '032', name: 'Argentina' }, { code: '076', name: 'Brazil' },
            { code: '840', name: 'United States' }, { code: '156', name: 'China' },
            { code: '392', name: 'Japan' }, { code: '250', name: 'France' },
            { code: '276', name: 'Germany' }, { code: '380', name: 'Italy' },
            { code: '724', name: 'Spain' }, { code: '826', name: 'United Kingdom' },
            { code: '643', name: 'Russia' }, { code: '356', name: 'India' },
            { code: '036', name: 'Australia' }, { code: '124', name: 'Canada' },
            { code: '484', name: 'Mexico' }, { code: '710', name: 'South Africa' },
            { code: '818', name: 'Egypt' }, { code: '792', name: 'Turkey' },
            { code: '410', name: 'South Korea' }, { code: '360', name: 'Indonesia' },
            // ... (Se debe completar en una implementaci√≥n final)
        ];

        // MOCK MEDIA REPO (En producci√≥n esto vendr√≠a del servidor)
        const MOCK_MEDIA = {
            '032': [
                { type: 'img', src: 'https://media.istockphoto.com/id/1146311634/es/foto/obelisco-buenos-aires-argentina.jpg?s=612x612&w=0&k=20&c=XMrz330d-i-4LqW8S2R2c5g9-k0Wb0d4E8q7G9n8G5k=', title: 'Obelisco' },
                { type: 'img', src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Glaciar_Perito_Moreno_-_Santa_Cruz_-_Argentina.jpg/1200px-Glaciar_Perito_Moreno_-_Santa_Cruz_-_Argentina.jpg', title: 'Perito Moreno' }
            ],
            '392': [
                { type: 'img', src: 'https://dummyimage.com/400x300/101820/fff&text=Tokyo+Streets', title: 'Tokyo Night' },
                { type: 'img', src: 'https://dummyimage.com/400x300/101820/fff&text=Kyoto+Temple', title: 'Kyoto Temple' }
            ]
        };

        // STATE
        let isAuto = false;
        let isDreaming = false;
        let currentQueue = [];

        // --- INIT ---
        window.onload = () => {
            populateCountries();
            pollStatus();
            setInterval(pollStatus, 1000); // Fast update
        };

        function populateCountries() {
            const sel = document.getElementById('country-select');
            ALL_COUNTRIES.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code;
                opt.innerText = `${c.name} (${c.code})`;
                sel.appendChild(opt);
            });
        }

        // --- CORE FUNCTIONS ---
        async function api(path, method = 'GET', body = null) {
            try {
                const opts = { method };
                if (body) {
                    opts.headers = { 'Content-Type': 'application/json' };
                    opts.body = JSON.stringify(body);
                }
                const res = await fetch(`/control-api${path}`, opts);
                return await res.json();
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
                return null;
            }
        }

        function log(msg, type = 'info') {
            const div = document.getElementById('console-log');
            const l = document.createElement('div');
            l.style.marginBottom = '5px';
            l.style.color = type === 'error' ? '#ef4444' : (type === 'cmd' ? '#38bdf8' : '#888');
            l.innerText = `> ${msg}`;
            div.prepend(l);
        }

        // --- ACTIONS ---
        async function toggleAuto() {
            log("Toggling Auto Mode...", 'cmd');
            // La l√≥gica real est√° en backend, aqu√≠ enviamos toggle
            // Para simplificar, enviamos evento 'auto_toggle' o usamos un endpoint espec√≠fico
            // Como no tenemos endpoint toggle, asumimos que el usuario quiere encender o apagar
            // Usaremos /event/auto_mode (que deberiamos crear o simular)
            // Por ahora, simulamos el cambio visual y dejamos que el poll corrija
            // Pero necesitamos decirle al server que cambie.
            // Crearemos un endpoint r√°pido en server o usamos uno existente.
            // Usaremos /event/auto_mode/on o off si existiera.
            // Fallback: endpoint gen√©rico
            await api('/event/auto_toggle', 'POST');
        }

        async function flyNow() {
            const code = document.getElementById('country-select').value;
            if (!code) return;
            log(`Flying to ${code}...`, 'cmd');
            await api(`/event/travel/${code}`);
        }

        async function addPlaylist() {
            const code = document.getElementById('country-select').value;
            if (!code) return;
            log(`Queueing ${code}...`, 'cmd');
            await api('/event/queue/add', 'POST', { code });
        }

        async function removeFromQueue(index) {
            // Nota: El backend actual de cola es simple array.
            // Necesitar√≠amos endpoint de borrado por √≠ndice. 
            // Por ahora, no implementado en backend, simularemos en frontend si podemos, 
            // pero el backend es la fuente de la verdad.
            // PENDIENTE: Endpoint delete.
            log("Remove not yet supported by server protocol.", 'error');
        }

        async function toggleDream() {
            // Force dream generation
            log("Forcing Dream Generation...", 'cmd');
            await api('/api/dream', 'POST');
            // Feedback visual temporal
            const btn = document.getElementById('btn-dream');
            btn.innerText = "GENERATING...";
            setTimeout(() => btn.innerText = "FORCE DREAM GENERATION", 2000);
        }

        function loadCountryMedia() {
            const code = document.getElementById('country-select').value;
            const container = document.getElementById('media-container');
            const count = document.getElementById('media-count');
            container.innerHTML = "";

            const media = MOCK_MEDIA[code] || []; // Fallback a vac√≠o
            count.innerText = `(${media.length})`;

            if (media.length === 0) {
                container.innerHTML = `<div style="grid-column: span 2; text-align: center; padding: 20px; color: #444;">No media found for ${code}.<br><button onclick="generateMedia('${code}')" style="margin-top:10px;">AUTO-GENERATE WITH AI</button></div>`;
                return;
            }

            media.forEach(m => {
                const item = document.createElement('div');
                item.className = 'media-item';
                item.innerHTML = `
                    <div class="media-prev" style="background-image: url('${m.src}'); background-size: cover;"></div>
                    <div style="font-size: 0.7rem; margin-top: 5px; color: #aaa;">${m.title}</div>
                    <div class="media-actions">
                        <button onclick="launchMedia('${m.src}')" style="background: var(--accent); color: black; border:none;">LAUNCH TO SCREEN</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        async function launchMedia(url) {
            log(`Launching media: ${url}`, 'cmd');
            // Enviar evento de media al orquestador
            await api('/event/media', 'POST', { url, type: 'image' });
        }

        async function generateMedia(code) {
            log(`Requesting AI generation for ${code}...`, 'cmd');
            // Placeholder logic
        }

        // --- POLLING LOOP ---
        async function pollStatus() {
            const data = await api('/status');
            if (!data) {
                document.getElementById('sys-led').className = 'indicator busy';
                return;
            }
            document.getElementById('sys-led').className = 'indicator on';

            // 1. UPDATE PLAYLIST
            const plContainer = document.getElementById('playlist-container');
            if (data.queue && JSON.stringify(data.queue) !== JSON.stringify(currentQueue)) {
                currentQueue = data.queue;
                plContainer.innerHTML = "";
                if (currentQueue.length === 0) {
                    plContainer.innerHTML = '<div style="text-align: center; color: #444; padding-top: 20px;">Lista vac√≠a</div>';
                } else {
                    currentQueue.forEach((code, idx) => {
                        const div = document.createElement('div');
                        div.className = 'playlist-item';
                        div.innerHTML = `<span>${idx + 1}. ${code}</span> <button class="btn-del" onclick="removeFromQueue(${idx})">x</button>`;
                        plContainer.appendChild(div);
                    });
                }
            }

            // 2. STATUS INDICATORS
            document.getElementById('stat-scene').innerText = data.currentScene || 'INTRO';
            const tel = data.telemetry || {};
            document.getElementById('stat-country').innerText = tel.country || '--';

            // 3. AUTO BUTTON STATE
            const btnAuto = document.getElementById('btn-auto-mode');
            if (data.autoMode) {
                btnAuto.innerText = "PILOTO AUTOM√ÅTICO: ON";
                btnAuto.style.background = ""; // Clear inline
                btnAuto.className = "indicator active-danger"; // Class handles Red Pulse
                // Hack: Button styling via class wasn't applied directly to button element logic in CSS properly for background override.
                // Let's force style directly
                btnAuto.style.backgroundColor = "rgba(220, 38, 38, 0.2)";
                btnAuto.style.borderColor = "#ef4444";
                btnAuto.style.color = "#ef4444";
                btnAuto.style.boxShadow = "0 0 15px rgba(239, 68, 68, 0.3)";
            } else {
                btnAuto.innerText = "MANUAL MODE";
                btnAuto.style.backgroundColor = "#27272a";
                btnAuto.style.borderColor = "#3f3f46";
                btnAuto.style.color = "#71717a";
                btnAuto.style.boxShadow = "none";
            }
        }

    </script>
</body>

</html>