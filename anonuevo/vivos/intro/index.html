<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Viaje de ilfass - Acto Cero</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Fondo de Datos Vivo */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            z-index: 1;
            overflow: hidden;
        }

        #globe-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.35;
            /* Presencia sutil de fondo */
        }

        .container {
            position: relative;
            z-index: 10;
            text-align: center;
            max-width: 800px;
            padding: 2rem;
        }

        /* Avatar */
        .avatar-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 2rem;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
            animation: pulse 4s infinite ease-in-out;
            position: relative;
            z-index: 20;
            background: #000;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Placeholder para la cara real */
            background: #334155;
        }

        /* Texto Manifiesto */
        .manifesto-text {
            font-size: 2rem;
            font-weight: 300;
            line-height: 1.4;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            /* Legibilidad sobre el globo */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .manifesto-text.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .highlight {
            color: #38bdf8;
            font-weight: 600;
        }

        /* Barra de progreso / Tiempo */
        .progress-line {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #38bdf8;
            width: 0%;
            transition: width 0.1s linear;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
            }

            50% {
                box-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
            }

            100% {
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
            }
        }
    </style>
</head>

<body>
    <div class="background">
        <canvas id="globe-canvas"></canvas>
    </div>

    <div class="container">
        <div class="avatar-container">
            <img src="avata-placeholder.png" class="avatar-img" alt="ilfass">
        </div>

        <div id="text-display" class="manifesto-text">
            Conectando Sistemas Narrativos...
        </div>
    </div>

    <div class="progress-line" id="progress"></div>

    <script>
        // --- 1. VISUALES: GLOBO DE DATOS D3 ---
        function initGlobe() {
            const canvas = document.getElementById('globe-canvas');
            const context = canvas.getContext('2d');
            let width = window.innerWidth;
            let height = window.innerHeight;

            canvas.width = width;
            canvas.height = height;

            const projection = d3.geoOrthographic()
                .scale(height / 2.5)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath(projection, context);

            // Cargar datos topogr√°ficos light
            d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').then(world => {
                const land = topojson.feature(world, world.objects.countries);
                const borders = topojson.mesh(world, world.objects.countries, (a, b) => a !== b);
                const sphere = { type: "Sphere" };

                let rotate = [0, -10];
                let velocity = 0.02;

                d3.timer(() => {
                    rotate[0] += velocity;
                    projection.rotate(rotate);

                    context.clearRect(0, 0, width, height);

                    // Esfera (Oceano oscuro)
                    context.beginPath();
                    path(sphere);
                    context.fillStyle = '#0a0a0a';
                    context.fill();

                    // Pa√≠ses (Puntos/Estilo Grid Sutil)
                    context.beginPath();
                    path(land);
                    context.fillStyle = '#1e293b';
                    context.fill();

                    // Bordes (Cyan tecnol√≥gico muy fino)
                    context.beginPath();
                    path(borders);
                    context.strokeStyle = 'rgba(56, 189, 248, 0.15)';
                    context.lineWidth = 1;
                    context.stroke();

                    // Brillo Atmosf√©rico
                    const grad = context.createRadialGradient(width / 2, height / 2, height / 2.5, width / 2, height / 2, height / 2 + 40);
                    grad.addColorStop(0, 'rgba(56, 189, 248, 0)');
                    grad.addColorStop(1, 'rgba(56, 189, 248, 0.05)');
                    context.fillStyle = grad;
                    context.fillRect(0, 0, width, height);
                });
            });

            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                projection.translate([width / 2, height / 2]).scale(height / 2.5);
            });
        }

        // --- 2. ORQUESTACI√ìN: ESCUCHA DEL PANEL DE CONTROL ---
        function startOrchestratorListener() {
            const CHECK_INTERVAL = 2000; // 2 segundos
            const SERVER_URL = '/control-api/status'; // Proxy Nginx maneja esto

            // Mapeo de escenas del servidor a URLs reales (circuito streaming)
            const SCENE_MAP = {
                // Nota: intro/portada/pais/reflexion/estado-actual fueron sacados del circuito streaming.
                // Mantener una URL segura para no caer en hojas vac√≠as.
                'intro': '/vivos/mapa/',
                'mapa': '/vivos/mapa/',
                'pais': '/vivos/mapa/',
                'reflexion': '/vivos/diario/'
            };

            setInterval(() => {
                fetch(SERVER_URL)
                    .then(res => res.json())
                    .then(data => {
                        // Si la escena activa NO es 'intro', redirigir
                        const targetScene = data.currentScene || 'intro';

                        // Si estamos en la intro y el servidor dice otra cosa, movernos
                        if (targetScene !== 'intro' && targetScene !== 'manual_override') {
                            console.log(`Orquestador: Cambio de escena detectado -> ${targetScene}`);
                            const targetUrl = SCENE_MAP[targetScene];
                            if (targetUrl) {
                                window.location.href = targetUrl;
                            }
                        }
                    })
                    .catch(err => console.warn("Orquestador desconectado:", err));
            }, CHECK_INTERVAL);
        }

        // --- 3. NARRATIVA Y VOZ (IA) ---
        const voiceConfig = { pitch: 1.0, rate: 1.0, volume: 1.0 };
        const script = [
            { text: "Conexi√≥n estable.", delay: 500 },
            { text: "Iniciando protocolos de viaje.", delay: 500 },
            { text: "Esto no es un stream infinito.", delay: 500 },
            { text: "Es un documento vivo <span class='highlight'>en tiempo real</span>.", delay: 500 },
            { text: "Soy <span class='highlight'>ilfass</span>.", delay: 800 },
            { text: "Y vamos a escribir la memoria del mundo.", delay: 500 },
            { text: "El sistema est√° listo.", delay: 2000 }
        ];

        let currentIndex = 0;
        const textDisplay = document.getElementById('text-display');
        const progressBar = document.getElementById('progress');
        const avatarContainer = document.querySelector('.avatar-container');
        let availableVoices = [];

        function loadVoices() { availableVoices = window.speechSynthesis.getVoices(); }
        window.speechSynthesis.onvoiceschanged = () => { loadVoices(); };

        function getBestVoice() {
            loadVoices();
            let best = availableVoices.find(v => v.lang.startsWith('es') && (v.name.includes('Google') || v.name.includes('Microsoft')) && (v.name.includes('Male') || v.name.includes('Pablo') || v.name.includes('Alvaro') || v.name.includes('Jorge')));
            if (!best) best = availableVoices.find(v => v.lang.startsWith('es') && (v.name.includes('Male') || v.name.includes('Hombre')));
            if (!best) best = availableVoices.find(v => v.lang.startsWith('es') && (v.name.includes('Google') || v.name.includes('Microsoft')));
            if (!best) best = availableVoices.find(v => v.lang.startsWith('es'));
            return best;
        }

        function speak(text, callback) {
            window.speechSynthesis.cancel();
            const cleanText = text.replace(/<[^>]*>?/gm, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            const voice = getBestVoice();

            if (voice) {
                utterance.voice = voice;
                const isExplicitlyMale = voice.name.includes('Male') || voice.name.includes('Hombre') || voice.name.includes('Pablo') || voice.name.includes('Alvaro');

                if (!isExplicitlyMale) {
                    utterance.pitch = 0.7; // Modular mujer a hombre
                    utterance.rate = 0.95;
                } else {
                    utterance.pitch = 1.0;
                    utterance.rate = 1.0;
                }
            }

            utterance.onstart = () => {
                avatarContainer.style.transition = "box-shadow 0.1s";
                avatarContainer.style.borderColor = "#38bdf8";
                avatarContainer.style.animation = "speaking 0.3s infinite alternate";
            };

            utterance.onend = () => {
                avatarContainer.style.animation = "pulse 4s infinite ease-in-out";
                avatarContainer.style.borderColor = "rgba(255, 255, 255, 0.1)";
                if (callback) callback();
            };

            utterance.onerror = (e) => { if (callback) callback(); };
            window.speechSynthesis.speak(utterance);
        }

        function playNextLine() {
            if (currentIndex >= script.length) {
                textDisplay.innerHTML = "<span style='font-size: 1rem; color: #64748b;'>ESPERANDO COMANDO DEL DIRECTOR...</span>";
                progressBar.style.width = "100%";
                return;
            }

            const line = script[currentIndex];
            textDisplay.classList.remove('visible');

            setTimeout(() => {
                textDisplay.innerHTML = line.text;
                textDisplay.classList.add('visible');

                const progress = ((currentIndex + 1) / script.length) * 100;
                progressBar.style.width = `${progress}%`;

                speak(line.text, () => {
                    currentIndex++;
                    setTimeout(playNextLine, line.delay);
                });
            }, 500);
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes speaking {
                0% { box-shadow: 0 0 20px #38bdf8; transform: scale(1); }
                100% { box-shadow: 0 0 60px #38bdf8; transform: scale(1.02); }
            }
        `;
        document.head.appendChild(styleSheet);

        function init() {
            initGlobe(); // Arrancar visuales
            startOrchestratorListener(); // Arrancar cerebro
            loadVoices();

            const overlay = document.createElement('div');
            Object.assign(overlay.style, {
                position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
                background: 'rgba(0,0,0,0.9)', zIndex: 1000, display: 'flex', flexDirection: 'column',
                justifyContent: 'center', alignItems: 'center', cursor: 'pointer'
            });

            overlay.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 20px;">üåê</div>
                <div style="border: 1px solid #38bdf8; padding: 15px 40px; color: #38bdf8; font-family: 'Outfit', sans-serif; letter-spacing: 2px; text-transform: uppercase;">
                    Iniciar Sistema Narrative
                </div>
            `;

            overlay.onclick = () => {
                overlay.style.opacity = 0;
                setTimeout(() => overlay.remove(), 500);
                window.speechSynthesis.resume();
                playNextLine();
            };
            document.body.appendChild(overlay);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>